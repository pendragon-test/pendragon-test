<div id="image-gallery{% if include.id_number %}-{{ include.id_number }}{% endif %}" class="image-gallery">
  <div id="gallery-sizer{% if include.id_number %}-{{ include.id_number }}{% endif %}" class="gallery-sizer"></div>
  {% for file in site.static_files %}
    {% if file.path contains include.folder %}
      {% assign extname = file.extname | downcase %}
      {% if '.jpg.jpeg.png.gif' contains extname %}
        {% assign filenameparts = file.path | split: "/" %}
        {% assign filename = filenameparts | last | replace: file.extname,"" %}
        <div class="image-wrapper">
          <a href="{{ file.path | relative_url }}" class="image">
            <img src="{{ file.path | relative_url }}" title="{{ filename }}" />
          </a>
        </div>
      {% endif %}
    {% endif %}
  {% endfor %}
</div>

<script>
$(document).ready(function() {
  lightGallery(document.getElementById('image-gallery'), {
    thumbnail: false,
    selector: '.image'
  });

  function resizeGridItem(item) {
    const img = item.querySelector('img');
    if (!img || !img.complete) return;

    const rowHeight = 10;
    const rowGap = 8; // matches gap
    const imgHeight = img.naturalHeight;
    const imgWidth = img.naturalWidth;
    const containerWidth = item.offsetWidth;

    // Calculate scaled height based on container width
    const scaledHeight = (imgHeight * containerWidth) / imgWidth;
    const rowSpan = Math.ceil(scaledHeight / (rowHeight + rowGap));

    item.style.gridRowEnd = `span ${rowSpan}`;
  }

  function resizeAllGridItems() {
    setTimeout(() => {
      const allItems = document.querySelectorAll('.image-wrapper');
      allItems.forEach(resizeGridItem);
    }, 100);
  }

  // Resize items when images load
  const images = document.querySelectorAll('.image-wrapper img');
  images.forEach(img => {
    if (img.complete && img.naturalHeight > 0) {
      resizeGridItem(img.parentElement);
    } else {
      img.addEventListener('load', () => {
        resizeGridItem(img.parentElement);
      });
    }
  });

  // Delay initial resize to ensure layout is complete
  setTimeout(resizeAllGridItems, 200);
  window.addEventListener('resize', resizeAllGridItems);
});
</script>

<style>
.image-gallery {
  display: flex;
  flex-direction: column;
  flex-wrap: wrap;
  height: 400px;
  overflow-x: auto;
  overflow-y: hidden;
  padding: 8px;
  gap: 8px;
  align-content: flex-start;
}

.image-wrapper {
  padding: 0;
  overflow: hidden;
  width: 150px;
  flex-shrink: 0;
}

.image-wrapper img {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
}
</style>
